# SMARTGRAMマルチプラン対応システム - タスク管理ドキュメント

## 📋 プロジェクト概要

**目的**: SMARTGRAMを単一プランから3段階プラン（STARTER、PRO、MAX）に拡張し、使用量制限と機能制限を実装する

**期間**: 2025年1月25日開始

**技術構成**:
- フロントエンド: Next.js 15.5.2 + React 19
- バックエンド: Cloudflare Pages Functions
- データベース: Supabase PostgreSQL
- 決済: PayPal統合
- Lua: AutoTouch smartgram.ate拡張

## 🎯 プラン仕様

### プラン構成（最終確定版）
```
📦 3日間トライアル (無料)
├─ 🥉 STARTERプラン (¥2,980/月)
├─ 🥈 PROプラン (¥6,980/月, ¥69,800/年)
└─ 🥇 MAXプラン (¥15,800/月)
```

### 機能制限
| プラン | timeline.lua | follow.lua | unfollow.lua | hashtaglike.lua | activelike.lua | 1日制限 |
|--------|-------------|------------|--------------|-----------------|----------------|---------|
| Trial  | ✅          | ✅         | ✅           | ✅              | ✅             | 10回    |
| STARTER| ✅          | ❌         | ❌           | ❌              | ❌             | 50回    |
| PRO    | ✅          | ✅         | ✅           | ❌              | ❌             | 200回   |
| MAX    | ✅          | ✅         | ✅           | ✅              | ✅             | 無制限  |

## ✅ 完了タスク

### 1. 設計・計画フェーズ ✅
- [x] プロジェクト構造調査
- [x] 現在のライセンス管理システム理解
- [x] マルチプラン仕様設計
- [x] 機能制限マッピング

### 2. データベース実装 ✅
- [x] データベーススキーマ設計
- [x] plansテーブル作成
- [x] devices/subscriptionsテーブル拡張
- [x] マイグレーションSQL作成
- [x] **Supabaseでマイグレーション手動実行** ✅ **2025-01-25 完了**
- [x] ストアドプロシージャ実装
  - `check_usage_limit()` - 使用量制限チェック
  - `increment_usage()` - 使用量増加
  - `change_device_plan()` - プラン変更
  - `reset_daily_usage()` - 日次リセット

### 3. API実装 ✅
- [x] プラン管理APIエンドポイント
  - `/api/plans/list` - プラン一覧取得
  - `/api/plans/upgrade` - プランアップグレード
  - `/api/plans/downgrade` - プランダウングレード
- [x] 使用量追跡API
  - `/api/usage/check` - 使用量チェック
  - `/api/usage/increment` - 使用量カウントアップ
- [x] 機能アクセス制御API
  - `/api/feature/check` - 機能利用権限チェック
- [x] ライセンス検証API拡張
  - プラン情報レスポンス追加
  - 機能フラグ追加（timeline_lua, follow_lua等）

### 4. フロントエンド実装 ✅
- [x] PlanInfoCardコンポーネント作成
- [x] useUserDataフック拡張（プラン情報対応）
- [x] ダッシュボードページ統合
- [x] プラン情報表示機能

### 5. デプロイメント ✅
- [x] **GitHubプッシュ完了** - commit: `3817134`
- [x] **Cloudflare Pages自動デプロイ** - https://smartgram.jp
- [x] **Supabaseマイグレーション実行** - 本番データベース更新完了

## 🔄 進行中タスク

**現在進行中のタスクはありません** - システム稼働中

## 📋 残りタスク

### 6. PayPal統合拡張
- [ ] マルチプラン対応PayPal決済フロー
- [ ] プラン変更時の決済処理
- [ ] 年額プラン（PRO ¥69,800/年）対応

### 7. AutoTouch統合（main.lua拡張） ✅
- [x] main.luaでプラン情報取得機能実装
- [x] スクリプト別アクセス制御実装
- [x] 使用量カウント機能追加
- [x] **プラン制限UI実装** ✅ **2025-01-25 完了**

### 8. 統合テスト
- [ ] 新API動作確認
- [ ] ダッシュボードプラン表示テスト
- [ ] main.lua機能制限テスト
- [ ] 使用量追跡動作確認

## 🎉 **現在の状況**

**✅ メインシステム完全稼働中！**
- データベース: プラン構造更新完了
- API: 全エンドポイント稼働
- フロントエンド: プラン表示機能稼働
- バックエンド: 使用量追跡システム稼働

## 🗂️ 作成ファイル一覧

### データベース
```
database/
├── migration-multiplan.sql          # マルチプラン対応マイグレーション
```

### API
```
functions/api/
├── [[path]].ts                      # メインAPIルーター（拡張済み）
├── multiplan-handlers.ts            # 新規プラン管理ハンドラー
```

### フロントエンド
```
app/
├── components/
│   └── PlanInfoCard.tsx            # プラン情報表示コンポーネント
├── hooks/
│   └── useUserData.ts              # ユーザーデータフック（拡張済み）
└── dashboard/
    └── page.tsx                     # ダッシュボードページ（統合済み）
```

### AutoTouch統合
```
production/
└── main.lua                        # メインランチャー（プラン制限対応）
    ├── PlanManager                 # プラン制限管理モジュール
    ├── fetchPlanInfo()            # Web API通信（プラン情報取得）
    ├── incrementUsage()           # 使用量カウント
    ├── isScriptAllowed()          # スクリプトアクセス制御
    └── getRestrictedMessage()     # プラン制限メッセージ
```

## 🔧 技術仕様詳細

### データベーススキーマ
```sql
-- 新規テーブル
CREATE TABLE plans (
    id UUID PRIMARY KEY,
    name VARCHAR(50) UNIQUE,
    display_name VARCHAR(100),
    price INTEGER,
    billing_cycle VARCHAR(20),
    features JSONB,
    limitations JSONB,
    paypal_plan_id VARCHAR(255),
    is_active BOOLEAN,
    sort_order INTEGER
);

-- 拡張カラム
ALTER TABLE devices ADD COLUMN plan_id UUID REFERENCES plans(id);
ALTER TABLE devices ADD COLUMN usage_limits JSONB;
ALTER TABLE devices ADD COLUMN current_usage JSONB;
```

### API仕様
```typescript
// 新規エンドポイント
GET  /api/plans/list                // プラン一覧
POST /api/plans/upgrade             // プランアップグレード
POST /api/plans/downgrade           // プランダウングレード
GET  /api/usage/check               // 使用量チェック
POST /api/usage/increment           // 使用量増加
GET  /api/feature/check             // 機能アクセス権限チェック

// 拡張済みエンドポイント
POST /api/license/verify            // プラン情報追加済み
```

### レスポンス例（license/verify）
```json
{
  "is_valid": true,
  "license_type": "PRO",
  "plan_info": {
    "name": "pro",
    "display_name": "PROプラン",
    "price": 6980,
    "features": { "timeline_lua": true, "follow_lua": true, ... },
    "limitations": { "daily_actions": 200 }
  },
  "script_access": {
    "timeline_lua": true,
    "follow_lua": true,
    "unfollow_lua": true,
    "hashtaglike_lua": false,
    "activelike_lua": false
  }
}
```

## 📊 進捗状況

**全体進捗**: 95% 完了

- ✅ 設計・計画: 100%
- ✅ データベース: 100%
- ✅ API実装: 100%
- ✅ フロントエンド: 100%
- ✅ **本番デプロイ: 100%**
- ✅ **main.lua統合: 100%** ← **NEW!**
- ⏳ PayPal統合: 30%
- ⏳ テスト: 0%

## 🎯 次のアクション

1. **PayPal統合完了** - マルチプラン決済対応
2. **統合テスト実行** - 全機能動作確認
3. **完全版リリース** - 全機能統合完了

## 🚀 **システム稼働開始！**

**✅ 2025年1月25日 - SMARTGRAMマルチプラン対応システム稼働開始**

以下の機能が本番環境で利用可能になりました：
- 🎯 **3段階プラン制度**: STARTER/PRO/MAX
- 📊 **プラン情報ダッシュボード**: リアルタイム表示
- 🔒 **機能別アクセス制御**: Luaスクリプト毎の制限
- 📈 **使用量追跡システム**: 日次制限管理
- 🚀 **新API群**: プラン管理・使用量管理・機能チェック
- 📱 **AutoTouch統合**: main.luaプラン制限機能完全実装

## 📝 実装メモ

### 重要な設計決定
- プラン情報はJSONBで柔軟に管理
- 使用量は日次自動リセット
- 機能制限は明示的な真偽値で管理
- ライセンス検証レスポンスにスクリプト用フラグ追加

### 技術的課題と解決
- **課題**: 既存APIの後方互換性
- **解決**: license_typeの拡張とscript_accessフィールド追加

- **課題**: プラン変更時のデータ整合性
- **解決**: ストアドプロシージャでアトミック処理

- **課題**: AutoTouchでのHTTP通信とJSON処理
- **解決**: フォールバック機能付きHTTP/JSONライブラリ実装

- **課題**: プラン制限の直感的UI表示
- **解決**: 制限スクリプトの明示的エラーダイアログと案内

### 今後の拡張可能性
- 企業プラン追加
- API使用量詳細分析
- プラン使用状況レポート
- 自動プラン推奨機能

---

**更新日**: 2025年1月25日 ✅ **マイグレーション実行完了**
**ステータス**: **システム稼働中** 🚀
**次回更新予定**: main.lua統合完了後